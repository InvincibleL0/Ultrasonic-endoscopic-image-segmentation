# Ultrasonic-endoscopic-image-segmentation

一、项目简介

超声内窥成像是基于检测超声信号在组织中的回波进行成像，可以对组织层次及附近器官成像，反映组织声阻抗的差异性。无创、无辐射、实时，从而可用于检查深层信息。超声内窥成像可以识别肠壁的组织结构，直观的分辨出各层的差异和界限。肠道疾病的早期诊断对于治疗具有重要意义，早期的肠道疾病往往伴随肠壁水肿、增厚，肠壁由黏膜、黏膜下层、肌层和浆膜层构成，肠壁增厚是肠道疾病的主要超声相关指标之一，不同层次的组织结构增厚可能反映了不同的肠道疾病类型。

对肠壁形态定量评估需要在肠壁横截面图像中将不同层次的组织结构的界限准确地描绘出来。然而单一横截面图像的定量评估对于诊断是无意义的，只有对大量连续的横截面组成的3D图像进行定量分析才能获得组织结构形态信息。当进入3D分割时，由于需要描绘大量2D成像切片，这种人工描绘边界变得十分耗时，自动化的肠壁分割方法使得定量分析更加现实，进而促进肠壁超声图像定量分析在临床中的应用。（fig.1）显示了肠壁横截面的组织结构。超声内窥图像目标区域灰度值范围有较大重叠，噪声较明显，虽然人工标注界限比较轻松，但由于超声图像组织结构的非均匀性，传统的非机器学习图像处理方法不能很好的将不同的声阻抗层识别并分割（fig.2）。

随着可用于图像分割的卷积神经网络的兴起。基于监督学习的端到端卷积神经网络方法，在此分割任务中可以发挥作用。目前，基于深度学习的图像分割方法在医学图像领域的应用越来越广泛，例如眼底图像血管分割、肺部CT图像分割、血管内超声图像分割等等。为了解决这一计算机视觉问题，我们提出了一种类似于Unet的全卷积神经网络方法，相较于传统图像分割技术，基于全卷积神经网络的方法，有更高的分割准确率和更低的时间复杂度。并且，基于全神经网络的方法可以做到多分类，将各层次的组织结构区分开来，省去了繁杂的区域选取步骤。

二、实现方法

1）漫水填充

漫水填充法是一种用特定的颜色填充联通区域，通过设置可连通像素的上下限以及连通方式来达到不同的填充效果的方法。简单来说，就是自动选中了和种子点相连的区域，接着将该区域替换成指定的颜色。

在OpenCV中，漫水填充是填充算法中最通用的方法。用C++重写过的FloodFill函数有两个版本，一个不带掩膜mask的版本，和一个带mask的版本。这个掩膜mask，就是用于进一步控制哪些区域将被填充颜色（比如说当对同一图像进行多次填充时）。这两个版本的FloodFill，都必须在图像中选择一个种子点，然后把临近区域所有相似点填充上同样的颜色，不同的是，不一定将所有的邻近像素点都染上同一颜色，漫水填充操作的结果总是某个连续的区域。当邻近像素点位于给定的范围（从loDiff到upDiff）内或在原始seedPoint像素值范围内时，FloodFill函数就会为这个点涂上颜色。

不带掩膜mask的版本：

int floodFill( InputOutputArray image, Point seedPoint, Scalar newVal, CV_OUT Rect* rect = 0, Scalar loDiff = Scalar(), Scalar upDiff = Scalar(), int flags = 4 );

带掩膜mask的版本：

int floodFill( InputOutputArray image, InputOutputArray mask, Point seedPoint, Scalar newVal, CV_OUT Rect* rect=0, Scalar loDiff = Scalar(), Scalar upDiff = Scalar(), int flags = 4 );


2）分水岭

分水岭算法会把跟临近像素间的相似性作为重要的参考依据，从而将在空间位置上相近并且灰度值相近（求梯度）的像素点互相连接起来构成一个封闭的轮廓。分水岭算法常用的操作步骤：彩色图像灰度化，然后再求梯度图，最后在梯度图的基础上进行分水岭算法，求得分段图像的边缘线。

OpenCV中watershed函数原型：

void watershed( InputArray image, InputOutputArray markers );

第一个参数 image，必须是一个8bit 3通道彩色图像矩阵。第二个参数是关键：在执行分水岭函数watershed之前，必须对第二个参数markers进行处理，它应该包含不同区域的轮廓，每个轮廓有一个自己唯一的编号，轮廓的定位可以通过OpenCV中findContours()方法实现，这个是执行分水岭之前的要求。算法会根据markers传入的轮廓作为种子（也就是所谓的注水点），对图像上其他的像素点根据分水岭算法规则进行判断，并对每个像素点的区域归属进行划定，直到处理完图像上所有像素点。

3）K-means

K-means算法是经典的聚类方法，基本思想是：以空间中K个点为中心进行聚类，对最靠近他们的对象归类。通过迭代的方法，逐次更新各聚类中心的值，直至得到最好的聚类结果。K-means算法的缺点也很明显：K值必须人为设定、K个中心点的随机性影响最终的分类结果。

OpenCV中kmeans函数原型：

double kmeans( InputArray data, int K, InputOutputArray bestLabels, TermCriteria criteria, int attempts, int flags, OutputArray centers = noArray() );

由于噪声点或者其它干扰因素的存在，使用以上三种算法常常存在过度分割的现象，这是因为很多很小的局部极值点的存在。并且无法避免手动操作，而我们的预期目的是实现全自动分割。

4）卷积神经网络

我们用之前开发的超声内窥成像系统对离体猪肠进行了成像，为分割任务准备一个数据集，提供给网络进行训练和测试。成像系统超声频率为40Mhz，由（fig.1.A和B）所示，肠壁由内而外呈现“暗-亮-暗-亮”的四层结构，分别为黏膜层、黏膜下层、肌层和浆膜层。数据集包含500张图像，分为训练集、验证集和测试集，比例为8：1：1。

如（fig.1.D）所示，我们开发了一种结构类似于U型的全卷积神经网络，主要由编码区和解码区组成。编码区包含4次下采样以获得高级特征映射，对应的解码区包含4次上采样以恢复图像原始分辨率并获得每个像素点的分类概率。在4次下采样前和4次上采样后添加了对应的合并结构，目的是结合高低语义信息，获得更细致的特征映射。在此全卷积神经网络中，编码区5个卷积单元、解码区4个卷积单元共19个卷积层、4个最大值汇聚层、4个上采样层。其中18个卷积层由大小3×3的滑动窗口卷积滤波器、线性修正单元组成，用来进行特征提取。最末尾的卷积层由大小1×1的滑动窗口卷积滤波器和Softmax激活函数组成，用来获得概率分布。最大值汇聚层为大小为2×2的滑动窗口滤波器，获得每个2×2像素区域的最大值，达到下采样的目的，使得特征图大小变为原来的四分之一，可以实现参数减少和特征选取。4个上采样层为2×2的滑动窗口卷积滤波器，插值方式为双线性插值，使得特征图大小扩大四倍，通过4个这样的上采样层将特征图恢复到原始图像大小。此外，为了避免过拟合，我们在最低分辨率的特征层使用了Dropout结构。

卷积神经网络的输入为512×512×1的2D超声肠壁图像切片，进入编码区第一层卷积单元，64个参数可学习的卷积滤波器分别与图像进行卷积，生成64个特征映射，特征映射的大小与输入图像一致，最大值池化层将图像下采样到256×256。随后的卷积单元继续生成图像特征映射，并减小图像大小，由此实现低级和高级卷积特征的分层提取。最底层卷积单元，生成1024个特征映射，将图像下采样到32×32。

上述编码区生成的特征映射进入解码区，经过参数可学习的上采样卷积层将图像大小增大4倍，随后与编码区中相应的单元进行合并，以更好的利用编码区中的特征映射恢复图像细节信息，并通过和编码区相同设置的卷积单元。经过4次上采样后，图像大小恢复到与输入图像大小一致。最后，经过一个包含3个大小1×1的卷积滤波器层降图像降至3维，激活函数为Softmax，生成每个像素点的概率分布。卷积神经网络的损失函数为交叉熵函数，作为网络卷积滤波器参数学习的依据。利用DICE系数来评价卷积神经网络的分割结果与人工标注真实分割结果之间的重合率。该神经网络用python编程语言和tensorflow深度学习框架实现，学习率为0.0001。
